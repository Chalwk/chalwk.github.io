<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width,initial-scale=1" name="viewport">
    <title>Communication Board</title>
    <link href="style.css" rel="stylesheet">

    <!-- PWA Meta Tags -->
    <meta content="#4a86e8" name="theme-color">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="default" name="apple-mobile-web-app-status-bar-style">
    <meta content="CommBoard" name="apple-mobile-web-app-title">
    <link href="icons/icon-192x192.png" rel="apple-touch-icon">

    <!-- Web App Manifest -->
    <link href="manifest.json" rel="manifest">

    <!-- Mobile meta tags for Web App -->
    <meta content="yes" name="mobile-web-app-capable">
    <meta content="CommBoard" name="application-name">
    <meta content="telephone=no" name="format-detection">
    <meta content="#4a86e8" name="msapplication-TileColor">
    <meta content="none" name="msapplication-config">
</head>
<body>
<div class="app-container">
    <header class="app-header">
        <div class="header-left">
            <h1>Communication Board</h1>
            <div class="header-sub">
                <label class="visually-hidden" for="categorySelect">Filter symbols by category</label>
                <select id="categorySelect" title="Filter by category">
                    <option value="All">All Categories</option>
                </select>
            </div>
        </div>

        <div class="header-controls">
            <div class="settings-dropdown">
                <button class="btn-secondary settings-toggle" id="settingsToggle" title="Settings">⚙️</button>
                <div class="settings-menu" id="settingsMenu">
                    <div class="settings-group">
                        <label class="visually-hidden" for="voiceSelect">Choose voice</label>
                        <select id="voiceSelect" title="Choose TTS voice"></select>
                    </div>
                    <div class="settings-group">
                        <button class="btn-secondary" id="editModeBtn">Edit Mode</button>
                        <button class="btn-primary" id="saveBtn">Save</button>
                    </div>
                    <div class="settings-group">
                        <button class="btn-secondary" id="exportBtn" title="Export symbols and settings">Export</button>
                        <label class="btn-secondary" for="importFile" title="Import symbols">Import
                            <input accept="application/json" id="importFile" style="display:none" type="file">
                        </label>
                    </div>
                    <div class="settings-group">
                        <button class="btn-secondary" id="manageCategoriesBtn">Manage Categories</button>
                    </div>
                </div>
            </div>

            <button class="btn-secondary" id="installBtn" style="display:none;" title="Install App">Install App</button>
            <button class="btn-secondary" id="undoBtn" title="Undo last phrase edit">Undo</button>
        </div>
    </header>

    <div class="main-content">
        <div class="phrase-bar">
            <div aria-live="polite" class="phrase-display" id="phraseDisplay" role="list">
                <span class="empty-message">Select symbols to build your phrase</span>
            </div>
            <div class="phrase-controls">
                <button class="btn-primary" id="speakBtn">Speak</button>
                <button class="btn-secondary" id="clearBtn">Clear</button>
            </div>
        </div>

        <div class="board-toolbar">
            <input type="text" id="globalSearch" placeholder="Search symbols..." aria-label="Search symbols">
        </div>

        <div aria-label="Communication board" class="board-container" id="boardWrap" tabindex="0">
            <div class="communication-board" id="communicationBoard" role="list">
                <!-- Symbols will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="app-footer">
        <div class="footer-content">
            <p>&copy; 2025 Communication Board - Jericho Crosby (Chalwk). All rights reserved.</p>
        </div>
    </footer>

    <!-- Edit Modal -->
    <div aria-hidden="true" aria-labelledby="modalTitle" aria-modal="true" class="modal" id="editModal" role="dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Edit Symbol</h2>
                <span aria-label="Close" class="close" id="closeModal" role="button">&times;</span>
            </div>
            <div class="modal-body">
                <form id="symbolForm">
                    <div class="form-group">
                        <label for="symbolText">Text</label>
                        <input id="symbolText" required type="text">
                    </div>
                    <div class="form-group">
                        <label for="symbolImage">Image URL or emoji</label>
                        <input id="symbolImage" placeholder="https:// or data:, or emoji" type="text">
                        <small>Or upload an image file</small>
                        <input accept="image/*" id="symbolImageFile" type="file">
                    </div>
                    <div class="form-group">
                        <label for="symbolColor">Background color</label>
                        <input id="symbolColor" type="color" value="#4a86e8">
                    </div>
                    <div class="form-group">
                        <label for="symbolCategory">Category</label>
                        <select id="symbolCategory">
                            <!-- Categories will be populated dynamically -->
                        </select>
                    </div>

                    <div class="form-actions">
                        <button class="btn-danger" id="deleteBtn" type="button">Delete</button>
                        <div style="display:flex; gap:8px">
                            <button class="btn-secondary" id="cancelEdit" type="button">Cancel</button>
                            <button class="btn-primary" type="submit">Save Changes</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Categories Management Modal -->
    <div aria-hidden="true" aria-labelledby="categoriesModalTitle" aria-modal="true" class="modal" id="categoriesModal"
         role="dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="categoriesModalTitle">Manage Categories</h2>
                <span aria-label="Close" class="close" id="closeCategoriesModal" role="button">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="newCategoryName">New Category Name</label>
                    <input id="newCategoryName" type="text" placeholder="Enter category name">
                    <button class="btn-primary" id="addCategoryBtn">Add Category</button>
                </div>

                <div class="categories-list" id="categoriesList">
                    <!-- Categories will be listed here -->
                </div>

                <div class="form-actions">
                    <button class="btn-secondary" id="closeCategoriesBtn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Symbol Button -->
    <button aria-label="Add new symbol" class="floating-btn" id="addSymbolBtn" title="Add New Symbol">+</button>
</div>

<!-- Toast area -->
<div aria-atomic="true" aria-live="assertive" class="toast" id="toast"></div>

<script defer src="script.js"></script>

<!-- Service Worker Registration -->
<script>
    // Register service worker for PWA functionality
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            // Use the correct path for your GitHub Pages subdirectory
            navigator.serviceWorker.register('/browser-apps/tools/communication-board/sw.js', {
                scope: '/browser-apps/tools/communication-board/'
            })
                .then(function(registration) {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
                .catch(function(error) {
                console.log('ServiceWorker registration failed: ', error);
            });
        });
    }

    // Add beforeinstallprompt event handler for install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log('App can be installed');
        updateInstallButton();
    });

    // Function to manually trigger install prompt
    function installApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                    showToast('App installed successfully!');
                } else {
                    console.log('User dismissed the install prompt');
                }
                deferredPrompt = null;
                updateInstallButton();
            });
        }
    }

    // Update install button visibility
    function updateInstallButton() {
        const installBtn = document.getElementById('installBtn');
        if (!installBtn) return;

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches ||
        window.navigator.standalone ||
        document.referrer.includes('android-app://');

        if (isStandalone) {
            installBtn.style.display = 'none';
        } else if (deferredPrompt || isIOS) {
            installBtn.style.display = 'block';
        } else {
            installBtn.style.display = 'none';
        }
    }

    // Listen for app installed event
    window.addEventListener('appinstalled', () => {
        deferredPrompt = null;
        updateInstallButton();
        console.log('App was installed');
        showToast('App installed successfully!');
    });

    // Initialize install button on load
    window.addEventListener('load', updateInstallButton);
</script>
</body>
</html>